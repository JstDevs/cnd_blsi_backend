const { ApprovalMatrix, documentType } = require('../config/database');
const { Op, fn, col } = require('sequelize');

async function getLatestApprovalVersion(likeString) {
  try {
    const result = await ApprovalMatrix.findOne({
      attributes: [
        [fn('MAX', col('Version')), 'LatestVersion']
      ],
      include: [{
        model: documentType,
        as: 'DocumentType',
        attributes: [],
        where: {
          Name: { [Op.like]: `%${likeString}%` }
        }
      }],
      where: {
        Active: true
      },
      raw: true
    });

    const version = result?.LatestVersion;

    // Return null if no approval matrix found (allows posting without approval workflow)
    if (!version) {
      console.warn(`⚠️ No approval matrix found for: "${likeString}". Document will be posted without approval workflow.`);
      return null;
    }

    return version;

  } catch (err) {
    console.warn('⚠️ Error retrieving approval version:', err.message);
    return null;
  }
}

module.exports = getLatestApprovalVersion;
